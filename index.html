<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Control Panel</title>

<style>
    body {
        font-family: Arial;
        background: #f2f4f7;
        padding: 20px;
        text-align: center;
    }
    .header {
        font-size: 26px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .card {
        width: 90%;
        max-width: 400px;
        margin: 15px auto;
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-align: left;
    }
    button {
        padding: 10px 18px;
        font-size: 18px;
        border-radius: 8px;
        border: none;
        margin: 5px;
        cursor: pointer;
    }
    .on { background: #27ae60; color:#fff; }
    .off { background: #e74c3c; color:#fff; }
    .running { background:#f39c12; color:#fff; }
    .progress-container {
        width: 100%;
        background: #ddd;
        height: 14px;
        border-radius: 10px;
        margin-top: 10px;
        overflow: hidden;
    }
    .progress-bar {
        width: 0%;
        height: 100%;
        background: #3498db;
        transition: width 0.2s linear;
    }
    .sensor-value {
        font-size: 22px;
        margin-top: 8px;
        font-weight: bold;
    }
</style>

</head>
<body>

<div class="header">ESP32 Global Control Panel</div>

<div class="card">
    <div class="title">Relay 1</div>
    <button id="r1" class="off">OFF</button>
</div>

<div class="card">
    <div class="title">Relay 2</div>
    <button id="r2" class="off">OFF</button>
</div>

<div class="card">
    <div class="title">Relay 3</div>
    <button id="r3" class="off">OFF</button>
</div>

<div class="card">
    <div class="title">Timed Relay</div>
    <button id="timerBtn" class="off">START</button>
    <div class="progress-container">
        <div class="progress-bar" id="progress"></div>
    </div>
    <div id="remainingText" style="margin-top:10px;font-weight:bold;">0 sec</div>
</div>

<div class="card">
    <div class="title">SHT20 Sensor</div>
    <div class="sensor-value">ðŸŒ¡ Temp: <span id="temp">--</span> Â°C</div>
    <div class="sensor-value">ðŸ’§ Humidity: <span id="hum">--</span> %</div>
</div>

<script type="module">

// ------------------ FIREBASE IMPORTS ------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// ------------------ YOUR FIREBASE CONFIG ------------------
const firebaseConfig = {
  apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
  authDomain: "mitdht.firebaseapp.com",
  databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
  projectId: "mitdht",
  storageBucket: "mitdht.firebasestorage.app",
  messagingSenderId: "994832787139",
  appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
  measurementId: "G-EWMWECH4BZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase();

// ------------------ HELPER: Update Relay Button ------------------
function updateBtn(btn, state, onText, offText) {
    if (state == 1) {
        btn.className = "on";
        btn.innerText = onText;
    } else {
        btn.className = "off";
        btn.innerText = offText;
    }
}

// ------------------ RELAYS ------------------
function relaySetup(btnId, firebasePath) {
    const btn = document.getElementById(btnId);

    onValue(ref(db, firebasePath), (snap) => {
        updateBtn(btn, snap.val(), "ON", "OFF");
    });

    btn.onclick = () => {
        const newState = btn.classList.contains("off") ? 1 : 0;
        set(ref(db, firebasePath), newState);
    };
}

relaySetup("r1", "device1/relay1");
relaySetup("r2", "device1/relay2");
relaySetup("r3", "device1/relay3");

// ------------------ SENSOR ------------------
onValue(ref(db, "device1/sensor/temp"), snap => {
    if (snap.exists()) document.getElementById("temp").innerText = snap.val().toFixed(2);
});

onValue(ref(db, "device1/sensor/hum"), snap => {
    if (snap.exists()) document.getElementById("hum").innerText = snap.val().toFixed(2);
});

// ------------------ TIMER ------------------
const timerBtn = document.getElementById("timerBtn");
const progress = document.getElementById("progress");
const remainingText = document.getElementById("remainingText");

let duration = 0;
let endTime = 0;

onValue(ref(db, "device1/timed/duration_ms"), s => duration = s.val());
onValue(ref(db, "device1/timed/end"), s => endTime = s.val());

onValue(ref(db, "device1/timed/state"), snap => {
    const running = snap.val();

    if (running == 1) {
        timerBtn.className = "running";
        timerBtn.innerText = "RUNNING";
    } else {
        timerBtn.className = "off";
        timerBtn.innerText = "START";
        progress.style.width = "0%";
        remainingText.innerText = "0 sec";
    }
});

// Smooth progress bar update (every 200ms)
setInterval(() => {
    if (endTime > 0 && duration > 0) {
        let remaining = endTime - Date.now();
        if (remaining < 0) remaining = 0;

        remainingText.innerText = Math.round(remaining / 1000) + " sec";

        let pct = ((duration - remaining) / duration) * 100;
        pct = Math.min(100, Math.max(0, pct));
        progress.style.width = pct + "%";
    }
}, 200);

timerBtn.onclick = () => {
    if (timerBtn.classList.contains("off")) {
        // Start timer
        const ms = 5000; // default
        set(ref(db, "device1/timed/duration_ms"), ms);
        set(ref(db, "device1/timed/end"), Date.now() + ms);
        set(ref(db, "device1/timed/state"), 1);
    } else {
        // Stop
        set(ref(db, "device1/timed/state"), 0);
    }
};

</script>
</body>
</html>
