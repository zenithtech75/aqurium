<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Cloud Control</title>

<style>
    body {
        font-family: Arial;
        background: #eef2f7;
        text-align: center;
        padding: 20px;
    }
    .container {
        max-width: 450px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0px 0px 20px rgba(0,0,0,0.1);
    }
    button {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        margin: 10px 0;
        border: none;
        border-radius: 10px;
        cursor: pointer;
    }
    .on { background: #27ae60; color: white; }
    .off { background: #c0392b; color: white; }
    #timerBar {
        width: 100%;
        height: 12px;
        background: #ddd;
        border-radius: 10px;
        margin-top: 10px;
        overflow: hidden;
    }
    #timerFill {
        height: 100%;
        width: 0%;
        background: #3498db;
        transition: width 0.3s linear;
    }
    .sensor-box {
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        background: #f3f3f3;
        font-size: 20px;
    }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Your Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
  authDomain: "mitdht.firebaseapp.com",
  databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
  projectId: "mitdht",
  storageBucket: "mitdht.firebasestorage.app",
  messagingSenderId: "994832787139",
  appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
  measurementId: "G-EWMWECH4BZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ==============================
//     SENSOR DISPLAY
// ==============================
onValue(ref(db, "device1/temperature"), snap => {
    document.getElementById("temp").innerText = snap.val() + " Â°C";
});

onValue(ref(db, "device1/humidity"), snap => {
    document.getElementById("humi").innerText = snap.val() + " %";
});

// ==============================
//     RELAY CONTROL
// ==============================
function toggleRelay(num) {
    const rRef = ref(db, "device1/relay" + num);

    onValue(rRef, snap => {
        const current = snap.val();
        set(rRef, current === 1 ? 0 : 1);
    }, { onlyOnce: true });
}
window.toggleRelay = toggleRelay;

// Update UI buttons
for (let i = 1; i <= 3; i++) {
    onValue(ref(db, "device1/relay" + i), snap => {
        const state = snap.val();
        const btn = document.getElementById("r" + i);
        btn.className = state === 1 ? "on" : "off";
        btn.innerText = `Relay ${i}: ${state === 1 ? "ON" : "OFF"}`;
    });
}

// ==============================
//     TIMER (Enabled Only)
// ==============================

onValue(ref(db, "device1/timer/enabled"), snap => {
    const state = snap.val();
    const bar = document.getElementById("timerFill");
    bar.style.width = state == 1 ? "100%" : "0%";
});

window.startTimer = function() {
    update(ref(db, "device1/timer"), { enabled: 1 });
};
</script>

</head>

<body>
<div class="container">

    <h2>ESP32 Cloud Controller</h2>

    <button id="r1" onclick="toggleRelay(1)" class="off">Relay 1</button>
    <button id="r2" onclick="toggleRelay(2)" class="off">Relay 2</button>
    <button id="r3" onclick="toggleRelay(3)" class="off">Relay 3</button>

    <h3>Timer</h3>
    <button class="on" onclick="startTimer()">ENABLE TIMER</button>

    <div id="timerBar"><div id="timerFill"></div></div>

    <div class="sensor-box">
        Temperature: <span id="temp">--</span><br>
        Humidity: <span id="humi">--</span>
    </div>

</div>
</body>
</html>
