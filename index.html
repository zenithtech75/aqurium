<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP32 Relays + SHT20 (Cloud)</title>
<style>
  body{font-family:Arial;margin:12px;background:#f6f7fb}
  h2{margin-top:6px}
  .relayBtn{width:140px;padding:10px;border:none;color:#fff;border-radius:8px;margin:6px;font-size:16px;cursor:pointer}
  .on{background:#2e7d32}.off{background:#c62828}.running{background:#fb8c00}
  .progress{width:100%;height:18px;border-radius:9px;background:#ddd;overflow:hidden;margin-top:8px}
  .bar{height:100%;width:0%;background:#2e7d32}
  label{font-weight:bold}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .card{border:1px solid #ddd;border-radius:12px;margin:12px 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.08);background:#fff}
  .card-header{padding:14px;background:#fafafa;font-size:18px;font-weight:600;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .card-content{max-height:0;overflow:hidden;transition:max-height 0.35s ease;padding:0 14px}
  .card-content.open{padding:14px}
  .small{font-size:13px;color:#666}
  .container{max-width:720px;margin:0 auto}
  input[type=number]{padding:8px;border-radius:6px;border:1px solid #ccc}
</style>
</head>
<body>
<div class="container">
  <h2>ESP32 Web Control (Cloud)</h2>

  <!-- CARD 1 : MANUAL RELAYS -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('c1')">
      Manual Relays
      <span>üîß</span>
    </div>
    <div class="card-content" id="c1">
      <div class="row">
        <button id="b1" class="relayBtn off" onclick="toggleRelay(1)">Relay1 OFF</button>
        <button id="b2" class="relayBtn off" onclick="toggleRelay(2)">Relay2 OFF</button>
        <button id="b3" class="relayBtn off" onclick="toggleRelay(3)">Relay3 OFF</button>
      </div>
      <div class="small">Buttons write to <code>device1/relay1</code> etc. ESP polls Firebase and applies.</div>
    </div>
  </div>

  <!-- CARD 2 : TIMED RELAY -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('c2')">
      Timer Relay
      <span>‚è±Ô∏è</span>
    </div>
    <div class="card-content" id="c2">
      <label>Duration (ms)</label>
      <input id="ms" type="number" value="5000" style="width:140px;padding:8px;font-size:15px">
      <button id="bt" class="relayBtn off" onclick="startTimed()">Start</button>
      <div id="info" style="margin-top:8px;font-weight:bold;"></div>
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="small" style="margin-top:8px">Starting writes <code>device1/timer/enabled = 1</code> ‚Äî ESP will run locally.</div>
    </div>
  </div>

  <!-- CARD 3 : SENSOR -->
  <div class="card">
    <div class="card-header" onclick="toggleCard('c3')">
      Sensor Readings
      <span>üå°Ô∏è</span>
    </div>
    <div class="card-content" id="c3">
      <p>Temperature: <span id="temp">--</span> ¬∞C</p>
      <p>Humidity: <span id="hum">--</span> %</p>
      <p>Last update: <span id="last">--</span></p>
    </div>
  </div>

  <div style="text-align:center;margin-top:8px;color:#666;font-size:13px">Hosted via Firebase ‚Äî accessible from any network</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
  authDomain: "mitdht.firebaseapp.com",
  databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
  projectId: "mitdht",
  storageBucket: "mitdht.firebasestorage.app",
  messagingSenderId: "994832787139",
  appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
  measurementId: "G-EWMWECH4BZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase();

// --- Helper to toggle card ---
function toggleCard(id){
  const c = document.getElementById(id);
  if(c.classList.contains('open')){
    c.style.maxHeight = '0px';
    c.classList.remove('open');
  } else {
    c.style.maxHeight = c.scrollHeight + 'px';
    c.classList.add('open');
  }
}
window.toggleCard = toggleCard;

// --- Relay listeners ---
function listenRelay(n, btnId){
  onValue(ref(db, `device1/relay${n}`), snap=>{
    const v = snap.exists()? snap.val():0;
    const btn = document.getElementById(btnId);
    if(v==1){ btn.className='relayBtn on'; btn.innerText=`Relay${n} ON`; }
    else{ btn.className='relayBtn off'; btn.innerText=`Relay${n} OFF`; }
  });
}
listenRelay(1,'b1'); listenRelay(2,'b2'); listenRelay(3,'b3');

// --- Toggle relay ---
async function toggleRelay(n){
  const path = `device1/relay${n}`;
  let cur=0;
  await new Promise(res => onValue(ref(db,path),snap=>{ cur=snap.exists()? snap.val():0; res(); }, { onlyOnce:true }));
  const newVal = cur===1?0:1;
  await set(ref(db,path), newVal);
}
window.toggleRelay = toggleRelay;

// --- Sensor listeners ---
onValue(ref(db,'device1/temperature'), snap=>{
  document.getElementById('temp').innerText = snap.exists()? Number(snap.val()).toFixed(2): '--';
});
onValue(ref(db,'device1/humidity'), snap=>{
  document.getElementById('hum').innerText = snap.exists()? Number(snap.val()).toFixed(2): '--';
});

// --- Timer listener ---
let curDuration = 0;
let curEnd = 0;

onValue(ref(db,'device1/timer/enabled'), snap=>{
  const st = snap.exists()? snap.val():0;
  const bt = document.getElementById('bt');
  if(st==1){ bt.className='relayBtn running'; bt.innerText='RUNNING...'; }
  else{ bt.className='relayBtn off'; bt.innerText='Start'; document.getElementById('bar').style.width='0%'; document.getElementById('info').innerText=''; }
});

// --- Progress bar (optional smooth update) ---
function tickProgress(){
  // ESP handles timing; this shows progress if desired
  requestAnimationFrame(tickProgress);
}
requestAnimationFrame(tickProgress);

// --- Start timed ---
async function startTimed(){
  const msVal = parseInt(document.getElementById('ms').value);
  if(!msVal || msVal<=0){ alert('Enter milliseconds > 0'); return; }
  // Write timer enabled = 1, ESP will handle timing locally
  await set(ref(db,'device1/timer/enabled'),1);
}
window.startTimed = startTimed;
</script>
</body>
</html>
