<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Global Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    button { padding: 12px 25px; margin: 10px; font-size: 18px; border: none; border-radius: 6px; cursor: pointer; }
    .on  { background: #4CAF50; color: white; }
    .off { background: #f44336; color: white; }
    .timed { background: #2196F3; color: white; }
    .card {
      padding: 20px;
      margin: 15px auto;
      width: 90%;
      max-width: 500px;
      border-radius: 10px;
      background: #f5f5f5;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
  </style>
</head>

<body>

<h1>ESP32 Global Controller</h1>

<div class="card">
  <h2>Sensor</h2>
  <p><b>Temperature:</b> <span id="temp">--</span> °C</p>
  <p><b>Humidity:</b> <span id="hum">--</span> %</p>
</div>

<div class="card">
  <h2>Relays</h2>
  <button id="r1" onclick="toggleRelay(1)">Relay 1</button>
  <button id="r2" onclick="toggleRelay(2)">Relay 2</button>
  <button id="r3" onclick="toggleRelay(3)">Relay 3</button>
</div>

<div class="card">
  <h2>Timed Relay ⏱️</h2>

  <label><b>Duration (ms)</b></label><br>
  <input type="number" id="delayInput" value="5000" 
         style="padding:10px; font-size:18px; width:150px; margin:10px;">
  <br>

  <button class="timed" onclick="startTimed()">RUN TIMED RELAY</button>

  <p><b>Remaining:</b> <span id="countdown">0</span> ms</p>
</div>

<!-- ===================== FIREBASE =========================== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
  authDomain: "mitdht.firebaseapp.com",
  databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
  projectId: "mitdht",
  storageBucket: "mitdht.firebasestorage.app",
  messagingSenderId: "994832787139",
  appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
  measurementId: "G-EWMWECH4BZ"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// =============== READ LIVE SENSOR DATA ===============
onValue(ref(db, "device1/sensor"), snap => {
  let d = snap.val();
  document.getElementById("temp").innerText = d.temp.toFixed(1);
  document.getElementById("hum").innerText  = d.hum.toFixed(1);
});

// =============== READ LIVE RELAY STATUS ===============
onValue(ref(db, "device1"), snap => {
  let d = snap.val();
  setButton("r1", d.relay1);
  setButton("r2", d.relay2);
  setButton("r3", d.relay3);

  // timer countdown
  let remain = d.timed.end - Date.now();
  document.getElementById("countdown").innerText = remain > 0 ? remain : 0;
});

// ======================= BUTTONS ======================
function toggleRelay(n) {
  let path = "device1/relay" + n;
  update(ref(db, "device1"), { ["relay"+n]: null }); // small hack to force event
  set(ref(db, path), 1);  // ESP inverts active-low
}

function startTimed() {
  let ms = parseInt(document.getElementById("delayInput").value);
  update(ref(db, "device1/timed"), {
    duration_ms: ms,
    state: 1,
    end: Date.now() + ms
  });
}

// ======================= UI HELPER ====================
function setButton(id, state) {
  let b = document.getElementById(id);
  if (state === 0) {
    b.className = "on";
    b.innerText = b.id.toUpperCase() + " ON";
  } else {
    b.className = "off";
    b.innerText = b.id.toUpperCase() + " OFF";
  }
}
</script>

</body>
</html>
