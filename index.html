<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Smart Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      background: #f2f2f2;
      font-family: Arial;
      text-align: center;
      padding: 20px;
    }
    h2 { margin-top: 10px; }

    .card {
      background: white;
      padding: 20px;
      margin: 15px;
      border-radius: 15px;
      box-shadow: 0 0 10px #ccc;
    }

    button {
      width: 120px;
      padding: 12px;
      margin: 8px;
      border-radius: 10px;
      border: none;
      font-size: 18px;
      color: white;
      cursor: pointer;
    }
    .on  { background: #28a745; }
    .off { background: #dc3545; }

    .progress {
      width: 90%;
      height: 22px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px auto;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #007bff;
      transition: width 0.2s linear;
    }
  </style>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ================================
    // ðŸ”¥ YOUR FIREBASE CONFIG
    // ================================
    const firebaseConfig = {
      apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
      authDomain: "mitdht.firebaseapp.com",
      databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
      projectId: "mitdht",
      storageBucket: "mitdht.firebasestorage.app",
      messagingSenderId: "994832787139",
      appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
      measurementId: "G-EWMWECH4BZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // =====================
    // ðŸ”¥ SENSOR LISTENERS
    // =====================

    // Temperature
    onValue(ref(db, "sensor/temperature"), (snap) => {
      document.getElementById("temp").innerText = snap.val() + "Â°C";
    });

    // Humidity
    onValue(ref(db, "sensor/humidity"), (snap) => {
      document.getElementById("humi").innerText = snap.val() + "%";
    });

    // =====================
    // ðŸ”¥ RELAY LISTENERS
    // =====================
    function bindRelay(id, firebasePath) {
      const button = document.getElementById(id);

      onValue(ref(db, firebasePath), (snap) => {
        const val = snap.val();
        button.innerText = val === 1 ? "ON" : "OFF";
        button.className = val === 1 ? "on" : "off";
      });

      button.onclick = () => {
        const newVal = button.innerText === "ON" ? 0 : 1;
        set(ref(db, firebasePath), newVal);
      };
    }

    bindRelay("btn1", "relay/R1");
    bindRelay("btn2", "relay/R2");
    bindRelay("btn3", "relay/R3");

    // =====================
    // ðŸ”¥ TIMER
    // =====================
    const progressBar = document.getElementById("progressBar");
    const timerText = document.getElementById("timerText");

    let totalTime = 0;
    let remaining = 0;

    // Full set time  
    onValue(ref(db, "timer/setTime"), (snap) => {
      totalTime = snap.val();
    });

    // Remaining countdown  
    onValue(ref(db, "timer/remaining"), (snap) => {
      remaining = snap.val();
      timerText.innerText = remaining + " sec";

      if (totalTime > 0) {
        let percent = (remaining / totalTime) * 100;
        progressBar.style.width = percent + "%";
      }
    });

    // Start Timer Button
    function startTimer() {
      const sec = Number(prompt("Enter seconds:"));
      if (sec > 0) {
        set(ref(db, "timer/setTime"), sec);
        set(ref(db, "timer/remaining"), sec);
      }
    }
    window.startTimer = startTimer;

  </script>
</head>

<body>

  <h2>ESP32 Smart Control</h2>

  <!-- SENSOR CARD -->
  <div class="card">
    <h3>Temperature & Humidity</h3>
    <p><b>Temperature:</b> <span id="temp">--</span></p>
    <p><b>Humidity:</b> <span id="humi">--</span></p>
  </div>

  <!-- RELAY CARD -->
  <div class="card">
    <h3>Relays</h3>
    <button id="btn1" class="off">OFF</button>
    <button id="btn2" class="off">OFF</button>
    <button id="btn3" class="off">OFF</button>
  </div>

  <!-- TIMER CARD -->
  <div class="card">
    <h3>Timer Relay</h3>

    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <p><b>Remaining:</b> <span id="timerText">0 sec</span></p>

    <button onclick="startTimer()" style="background:#17a2b8">Set Timer</button>
  </div>

</body>
</html>
