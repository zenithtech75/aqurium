<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ESP32 Relays + SHT20 (Cloud)</title>
  <style>
  body{font-family:Arial;margin:12px;background:#f6f7fb}
  h2{margin-top:6px;text-align:center}
  .relayBtn{width:140px;padding:10px;border:none;color:#fff;border-radius:8px;margin:6px;font-size:16px;cursor:pointer}
  .on{background:#2e7d32}.off{background:#c62828}.running{background:#fb8c00}
  .progress{width:100%;height:18px;border-radius:9px;background:#ddd;overflow:hidden;margin-top:8px}
  .bar{height:100%;width:0%;background:#2e7d32}
  label{font-weight:bold}
  .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}

/* Card styles */
.card{border:1px solid #999;border-radius:12px;margin:12px 0;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.15);background:#fff}
.card-header{padding:14px;background:#f2f2f2;font-size:18px;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.card-header span{font-size:20px;}
.card-content{max-height:0;overflow:hidden;transition:max-height 0.35s ease;padding:0 14px}
.card-content.open{ padding:14px }
.small{font-size:13px;color:#666}
.container{max-width:720px;margin:0 auto}
.footer{font-size:12px;color:#888;margin-top:10px;text-align:center}
input[type="number"]{padding:8px;border-radius:6px;border:1px solid #ccc}
  </style>
</head>
<body>
  <div class="container">
    <h2>ESP32 Web Control (Cloud)</h2>

    <!-- CARD 1 : MANUAL RELAYS -->
    <div class="card">
      <div class="card-header" onclick="toggleCard('c1')">
        Manual Relays
        <span>üîß</span>
      </div>
      <div class="card-content" id="c1">
        <div class="row">
          <button id="b1" class="relayBtn off" onclick="toggleRelay('R1','b1')">Relay1 OFF</button>
          <button id="b2" class="relayBtn off" onclick="toggleRelay('R2','b2')">Relay2 OFF</button>
          <button id="b3" class="relayBtn off" onclick="toggleRelay('R3','b3')">Relay3 OFF</button>
        </div>
        <div class="small">Buttons control Firebase path `relay/Rx` (ESP must read these).</div>
      </div>
    </div>

    <!-- CARD 2 : TIMED RELAY -->
    <div class="card">
      <div class="card-header" onclick="toggleCard('c2')">
        Timed Relay
        <span>‚è±Ô∏è</span>
      </div>
      <div class="card-content" id="c2">
        <label>Duration (ms)</label>
        <input id="ms" type="number" placeholder="5000" style="width:140px;padding:8px;font-size:15px">
        <button id="bt" class="relayBtn off" onclick="startTimer()">Start</button>
        <div id="info" style="margin-top:8px;font-weight:bold;"></div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div class="small" style="margin-top:8px">This will write object to `timer/command`. ESP must listen and update `timer/status`.</div>
      </div>
    </div>

    <!-- CARD 3 : SENSOR -->
    <div class="card">
      <div class="card-header" onclick="toggleCard('c3')">
        Sensor Readings
        <span>üå°Ô∏è</span>
      </div>
      <div class="card-content" id="c3">
        <p>Temperature: <span id="temp">--</span> ¬∞C</p>
        <p>Humidity: <span id="hum">--</span> %</p>
        <p>Last update: <span id="last">--</span></p>
      </div>
    </div>

    <div class="footer">Firebase: mitdht-default-rtdb</div>
  </div>

  <!-- Firebase module script (works on Netlify) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ----- your Firebase config (you provided earlier) -----
    const firebaseConfig = {
      apiKey: "AIzaSyC7du6Zwd0y6-DQQoiDdopCqKtWqUBbaT8",
      authDomain: "mitdht.firebaseapp.com",
      databaseURL: "https://mitdht-default-rtdb.firebaseio.com",
      projectId: "mitdht",
      storageBucket: "mitdht.firebasestorage.app",
      messagingSenderId: "994832787139",
      appId: "1:994832787139:web:f0f6f2ea177b1476af2476",
      measurementId: "G-EWMWECH4BZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Helper: toggle card open/close
    function toggleCard(id){
      const c = document.getElementById(id);
      if(c.classList.contains('open')){
        c.style.maxHeight = '0px'; c.classList.remove('open');
      } else {
        c.style.maxHeight = c.scrollHeight + 'px'; c.classList.add('open');
      }
    }
    window.toggleCard = toggleCard;

    // Toggle relay: write to /relay/Rx (0 or 1)
    async function toggleRelay(relayId, btnId){
      const path = `relay/${relayId}`;
      const btn = document.getElementById(btnId);

      // read current value once (if not present assume 0)
      let valSnap = await new Promise(res => onValue(ref(db, path), snap => { res(snap); }, { onlyOnce: true }));
      let cur = valSnap.exists() ? valSnap.val() : 0;
      const newVal = cur === 1 ? 0 : 1;
      await set(ref(db, path), newVal);
      // UI will update via listener below
    }
    window.toggleRelay = toggleRelay;

    // Setup live listeners for relays
    function listenRelay(relayId, btnId){
      onValue(ref(db, `relay/${relayId}`), snap => {
        const val = snap.exists() ? snap.val() : 0;
        const btn = document.getElementById(btnId);
        if(val === 1){
          btn.classList.remove('off'); btn.classList.add('on'); btn.innerText = `${relayId} ON`;
        } else {
          btn.classList.remove('on'); btn.classList.add('off'); btn.innerText = `${relayId} OFF`;
        }
      });
    }
    listenRelay('R1','b1');
    listenRelay('R2','b2');
    listenRelay('R3','b3');

    // Timer UI behavior
    const bt = document.getElementById('bt');
    const info = document.getElementById('info');
    const bar = document.getElementById('bar');

    // Start timer: write command object to timer/command
    async function startTimer(){
      const ms = parseInt(document.getElementById('ms').value);
      if(!ms || ms <= 0){ alert('Enter milliseconds > 0'); return; }
      const cmd = { duration_ms: ms, start_ms: Date.now() };
      // use set so previous commands are replaced
      await set(ref(db, 'timer/command'), cmd);
      // optional: write also a "requested" flag
      await set(ref(db, 'timer/requestedAt'), Date.now());
      // UI will be updated by timer/status listener
    }
    window.startTimer = startTimer;

    // Listen timer/status (updated by ESP)
    onValue(ref(db, 'timer/status'), snap => {
      const st = snap.exists() ? snap.val() : null;
      if(!st){
        // no timer
        bt.classList.remove('running'); bt.classList.add('off'); bt.innerText = 'Start';
        info.innerText = '';
        bar.style.width = '0%';
        return;
      }
      const running = st.running === 1 || st.running === true;
      const duration = Number(st.duration_ms || 0);
      const remaining = Number(st.remaining_ms || 0);

      if(running){
        bt.classList.remove('off'); bt.classList.add('running'); bt.innerText = 'RUNNING...';
        info.innerText = 'Auto-off in ' + Math.max(0, Math.round(remaining)) + ' ms';
      } else {
        bt.classList.remove('running'); bt.classList.add('off'); bt.innerText = 'Start';
        info.innerText = '';
      }

      // progress
      let pct = duration>0 ? ((duration - Math.max(0, remaining))/duration)*100 : 0;
      pct = Math.min(100, Math.max(0, pct));
      bar.style.width = pct + '%';
    });

    // Sensor listeners
    onValue(ref(db, 'sensor/temp'), snap => {
      const v = snap.exists() ? snap.val() : null;
      document.getElementById('temp').innerText = v !== null ? Number(v).toFixed(2) : '--';
    });
    onValue(ref(db, 'sensor/hum'), snap => {
      const v = snap.exists() ? snap.val() : null;
      document.getElementById('hum').innerText = v !== null ? Number(v).toFixed(2) : '--';
    });
    onValue(ref(db, 'sensor/lastUpdate'), snap => {
      const v = snap.exists() ? snap.val() : null;
      document.getElementById('last').innerText = v ? v : '--';
    });

    // On load: open sensor card
    window.addEventListener('load', ()=> {
      // auto-open sensor card after initial load
      setTimeout(()=>{ toggleCard('c3'); }, 150);
    });

  </script>
</body>
</html>
